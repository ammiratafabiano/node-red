module.exports = function(RED) {
    function httpListener(config) {

        RED.nodes.createNode(this,config);
        var node = this;
        
        const http = require('http');
        var fs = require('fs');
        const unique = require('node-unique');
        
        node.status({fill:"blue",shape:"dot",text:"localhost:8088"});
        
		var server = http.createServer((request, response) => {
		
			let body = [];
			request.on('error', (err) => {
				console.error(err);
			}).on('data', (chunk) => {
				body.push(chunk);
			}).on('end', () => {
				body = Buffer.concat(body).toString();

				response.on('error', (err) => {
					console.error(err);
				});
		
				function inputListener(msg) {
					if (msg._msgid == currentID) {
						response.statusCode = 200;
						response.setHeader("Access-Control-Allow-Origin", "*");
						response.setHeader("Content-Type", "text/html");
						response.end(JSON.stringify(msg.payload));
					}
					else {
						node.once('input', inputListener);
					}
				}
				node.once('input', inputListener);
				
				let currentID = unique();
				
				msg = {_msgid: currentID, topic: request.url, payload: true, unique};
				node.send(msg);

			});
  				
		}).listen(8088);
		
		node.on('close', function() {
			server.close();
		});
    }
    RED.nodes.registerType("httpService",httpListener);
}