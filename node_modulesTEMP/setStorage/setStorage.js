module.exports = function(RED) {
    function setStorage(config) {

        RED.nodes.createNode(this,config);
        this.prefix = config.prefix;
        var node = this;
        
        var port = this.prefix;
        
        var fs = require('fs');
        
        var storage = [];
        
		node.on('input', function(msg) {

			fs.readFile('storage.json', 'utf8', function (err, data) {
				if (!err) {
					storage = JSON.parse(data);
				}
				
				var newItem = { url:msg.topic, data:msg.payload };
				
				var index = storage.findIndex(x => x.url == newItem.url);
				if (index > -1) {
					storage.splice(index, 1);
				}
				storage.push(newItem);
				
				fs.writeFile("storage.json", JSON.stringify(storage), function(err) {
					if(!err) {
				
					}
				});
			});		
		});
		
		node.on('close', function() {
			server.close();
		});
    }
    RED.nodes.registerType("setStorage", setStorage);
}