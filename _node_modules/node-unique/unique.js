var uuid = require('uuid');

var pad = "0000000000000000";

function create(ts) {
  ts = ts || (new Date());
  ts = (new Date(ts)).getTime().toString(16);
  ts = pad.substring(0, 16 - ts.length) + ts;
  var random = uuid.v4().replace(/-/g, '');
  var hexId = ts + random;
  var id =  new Buffer(hexId, 'hex').toString('base64')
  id = id.replace(/\+/g, '-');
  id = id.replace(/\//g, '_');
  return id;
}

function getTimestamp(id) {
  id = id.replace(/_/g, '/');
  id = id.replace(/-/g, '+');
  var hexId = new Buffer(id, 'base64').toString('hex');
  var tsHex = hexId.substring(0, 16);
  var ts = parseInt(tsHex, 16);
  return new Date(ts);
}

create.getTimestamp = getTimestamp;

module.exports = create;
